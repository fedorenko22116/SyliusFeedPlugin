{% extends '@SyliusAdmin/shared/layout/base.html.twig' %}

{% block title %}{{ 'setono_sylius_feed.ui.feed'|trans ~ ' ' ~ feed.name }} {{ parent() }}{% endblock %}

{% block body %}
    {% include '@SyliusAdmin/shared/crud/common/sidebar.html.twig' %}

    <div class="page-wrapper">
        {% include '@SyliusAdmin/shared/crud/common/navbar.html.twig' %}

        <div class="page-body">
            <div class="container-xl">
                {% include '@SetonoSyliusFeedPlugin/Admin/Feed/Show/_header.html.twig' %}

                {% include '@SetonoSyliusFeedPlugin/Admin/Feed/Show/_breadcrumb.html.twig' %}

                {% if workflow_has_marked_place(feed, constant('Setono\\SyliusFeedPlugin\\Workflow\\FeedGraph::STATE_READY')) or workflow_has_marked_place(feed, constant('Setono\\SyliusFeedPlugin\\Workflow\\FeedGraph::STATE_PROCESSING')) %}
                    <div class="card mb-3">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead>
                                <tr>
                                    <th>{{ 'sylius.ui.channel'|trans }}</th>
                                    <th>{{ 'sylius.ui.locale'|trans }}</th>
                                    <th>{{ 'setono_sylius_feed.ui.link'|trans }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for channel in feed.channels %}
                                    {% for locale in channel.locales %}
                                        <tr>
                                            <td>{{ channel.name }}</td>
                                            <td>{{ locale.name }}</td>
                                            <td>
                                                <div class="input-group">
                                                    <input id="link-{{ loop.parent.loop.index }}-{{ loop.index }}" type="text" class="form-control form-control-sm" value="{{ setono_sylius_feed_generate_feed_url(feed, channel, locale) }}" readonly>
                                                    <button class="btn btn-outline-secondary btn-sm copy-link-btn" type="button" data-link-id="link-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                                        {{ 'setono_sylius_feed.ui.click_to_copy'|trans }}
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <strong>{{ 'setono_sylius_feed.ui.unprocessed_feed_header'|trans }}</strong>
                        <p class="mb-0">{{ 'setono_sylius_feed.ui.unprocessed_feed_body'|trans }}</p>
                    </div>
                {% endif %}

                {% if feed.violations|length > 0 %}
                    <h2>{{ 'setono_sylius_feed.ui.violation_summary'|trans }}</h2>
                    <p>{{ 'setono_sylius_feed.ui.view_all_violations'|trans({'%path%': path('setono_sylius_feed_admin_feed_violations_index', {'id': feed.id})})|raw }}</p>
                    {{ render(controller('setono_sylius_feed.controller.action.admin.severity_count', {'feed': feed.id})) }}
                {% endif %}
            </div>
        </div>

        {% include '@SyliusAdmin/shared/crud/common/content/footer.html.twig' %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.querySelectorAll('.copy-link-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var input = document.getElementById(this.getAttribute('data-link-id'));
                navigator.clipboard.writeText(input.value);
                var original = this.textContent;
                this.textContent = 'âœ“';
                setTimeout(function() { btn.textContent = original; }, 2000);
            });
        });
    </script>
{% endblock %}
